# IM系统开发

## 协议设计

### 需要考虑的方面

1. 数据大小：数据流量、耗电量、通信速度
2. 安全性：敏感数据的网络安全
3. 编码复杂度
4. 通用性、扩展性
5. 兼容性（新老版本的无缝融合）
6. 可调试性

### 常见协议比较

1. XMPP
   - 优点：基于xml协议，容易理解，使用广泛，易于扩展。
   - 缺点：流量大，在移动终端也耗电。交互过程复杂。多被pc时代的产品使用，不适合移动时代的IM产品，即使我们基于xmpp进行改进，简化握手过程，改进文件传输机制，但是它的基因决定了如何改进，它都不适合移动互联网时代的IM产品。
2. MQTT
   - 优点：适配多平台。
   - 缺点：协议简单，但是需要自己扩展好友，群组等功能。
3. Protobuf
   - 优点：非常小、非常快、非常简单，一条消息数据用Protobuf序列化后的大小是JSON的1/10、XML格式的1/20、是二进制序列化的1/10。
   - 缺点：不能表示复杂的数据结构，但是对于IM来讲，已经足够。
4. 私有协议
   - 优点：随心所欲，自己定义，流量小。
   - 工作量巨大，扩展性差，需要考虑全面。

一般的做法是：定长二进制包头，可扩展变长包体。包头负责传输和解析效率，与业务无关。包体保证扩展性，与业务相关。包体可以使用文本、XML等扩展性好的协议。





```c
struct Msg {
    uint32 id;
    uint16 code;
    uint8 version;
    uint2 flag;
    byte[] header;
    bype[] body;
}
```



### 参考资料

- [简述移动端IM开发的那些坑：架构设计、通信协议和客户端](http://www.52im.net/thread-289-1-1.html)
- [理论联系实际：一套典型的IM通信协议设计详解](http://www.52im.net/thread-283-1-1.html)
- 